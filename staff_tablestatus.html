<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Table Status</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { background:#fff; }
    .navbar-custom { background:#dc3545; color:#fff; }
    .navbar-custom .brand { font-weight:800; font-size:1.6rem; color:#fff; text-decoration:none; }
    .sidebar { background:#fef6e4; min-height:100vh; padding-top:1rem; }
    .sidebar h6 { color:#c5a880; font-weight:700; margin-bottom:1rem; padding-left:1rem; }
    .sidebar .nav-link { color:#000; font-weight:600; border-radius:.5rem; margin:.25rem .5rem; }
    .sidebar .nav-link.active { background:#fde68a; color:#000; }
    .table-card { background:#fff6eb; border-radius:1rem; padding:.6rem 1rem; display:inline-block; margin:.5rem; min-width:170px; cursor:pointer; border:1px solid #f8e1ca; }
    .status-available { color:#28a745; font-weight:bold; }
    .status-unavailable { color:#dc3545; font-weight:bold; }
    .status-reserved { color:#ffc107; font-weight:bold; }
    .debug { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#f8f9fa; border:1px dashed #ccc; padding:.5rem; border-radius:.5rem; }
  </style>
</head>
<body>
<nav class="navbar navbar-custom px-3">
  <a href="#" class="brand">Ran A Han</a>
  <div class="ms-auto d-flex align-items-center gap-3">
    <div class="user-info d-flex align-items-center gap-2">
      <span>Username<br><small class="fw-normal">Staff</small></span>
      <img src="https://via.placeholder.com/40" alt="User">
    </div>
    <button class="btn btn-sm btn-light"><i class="bi bi-bell-fill"></i></button>
    <button class="btn btn-sm btn-light"><i class="bi bi-gear-fill"></i></button>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <div class="col-12 col-md-3 col-lg-2 sidebar">
      <h6>FEATURES</h6>
      <nav class="nav flex-column">
        <a class="nav-link" href="staff_stock.html">Stock</a>
        <a class="nav-link" href="staff_order.html">Order</a>
        <a class="nav-link active" href="staff_tablestatus.html">TableStatus</a>
        <a class="nav-link" href="staff_payment.html">Payment</a>
      </nav>
    </div>

    <div class="col-12 col-md-9 col-lg-10 p-4">
      <h2 class="mb-3">TableStatus</h2>
      <div class="mb-2 small text-muted">* Click a table to update status</div>
      <div id="alerts"></div>
      <div id="tableContainer" class="d-flex flex-wrap"></div>
      <div id="debug" class="debug mt-3 d-none"></div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <h5 id="modalTableTitle"></h5>
      <p>Update Status</p>
      <select class="form-select" id="statusSelect">
        <option value="Unavailable">Unavailable</option>
        <option value="Available">Available</option>
        <option value="Reserved">Reserved</option>
      </select>
      <div class="d-flex justify-content-between mt-3">
        <button class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success" id="confirmStatus">Confirm</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ==== ตั้งค่าลิงก์ไป backend ให้ตรงกับ server.js ของคุณ =====
  const SERVER_ORIGIN = 'http://localhost:3000';

  const $ = (id)=>document.getElementById(id);
  const alertBox = $('alerts');
  const dbg = $('debug');

  function showAlert(msg, type='warning'){
    alertBox.innerHTML = `<div class="alert alert-${type} py-2">${msg}</div>`;
  }
  function clearAlert(){ alertBox.innerHTML = ''; }
  function showDebug(obj){
    dbg.classList.remove('d-none');
    dbg.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
  }

  function statusHTML(s){
    if (s === "Available")  return `<span class='status-available'>Available</span>`;
    if (s === "Unavailable")return `<span class='status-unavailable'>Unavailable</span>`;
    if (s === "Reserved")   return `<span class='status-reserved'>Reserved</span>`;
    return s || '';
  }

  async function loadTables(){
    const url = `${SERVER_ORIGIN}/api/tables`;
    const r = await fetch(url, { headers:{'Accept':'application/json'}, mode:'cors' });
    if(!r.ok){
      const t = await r.text().catch(()=> '');
      throw new Error('GET /api/tables failed: ' + r.status + ' ' + t);
    }
    return await r.json();
  }

  function drawTables(tables){
    const box = $('tableContainer');
    box.innerHTML = '';
    if(!Array.isArray(tables) || tables.length === 0){
      box.innerHTML = `<div class="text-muted">No tables</div>`;
      return;
    }
    tables.forEach(t=>{
      const div = document.createElement('div');
      div.className = 'table-card';
      div.dataset.id = t.id;
      div.dataset.status = t.status;
      const label = t.table_number ? `Table ${t.table_number}` : `Table ID : ${String(t.id).padStart(2,'0')}`;
      div.innerHTML = `${label}<br>${statusHTML(t.status)}`;
      div.onclick = () => openModal(t.id, t.status, label);
      box.appendChild(div);
    });
  }

  const modal = new bootstrap.Modal(document.getElementById('statusModal'));
  let selectedId = null;
  function openModal(id, status, label){
    selectedId = id;
    $('modalTableTitle').innerText = label;
    $('statusSelect').value = status || 'Available';
    modal.show();
  }

  async function confirmUpdate(){
    const status = $('statusSelect').value;
    if(!selectedId) return;
    try{
      const r = await fetch(`${SERVER_ORIGIN}/api/tables/${selectedId}/status`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ status }),
        mode:'cors'
      });
      if(!r.ok){
        const t = await r.text().catch(()=> '');
        throw new Error('PUT /api/tables/:id/status failed: ' + r.status + ' ' + t);
      }
      modal.hide();
      clearAlert();
      await refresh();
    }catch(e){
      console.error(e);
      showAlert(e.message || 'Update failed', 'danger');
      showDebug(e.message || e);
    }
  }
  document.getElementById('confirmStatus').addEventListener('click', confirmUpdate);

  async function refresh(){
    try{
      clearAlert();
      const tables = await loadTables();
      drawTables(tables);
    }catch(e){
      console.error(e);
      showAlert('Cannot load tables from server. Check SERVER_ORIGIN, CORS, and server status.', 'danger');
      showDebug(e.message || e);
    }
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    await refresh();
    // auto-refresh ทุก 10 วินาที เพื่อสะท้อนการจองจากฝั่งลูกค้า
    setInterval(refresh, 10000);
  });
</script>
</body>
</html>
